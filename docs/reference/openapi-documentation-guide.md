# OpenAPI Documentation Guide

## Overview

The Prompt Lab API provides comprehensive OpenAPI (Swagger) documentation that is automatically generated by FastAPI. This guide explains how to access and use the API documentation.

## Accessing the Documentation

The API provides two documentation interfaces:

### 1. Swagger UI (Interactive)

**URL**: `http://localhost:8000/docs`

Swagger UI provides an interactive interface where you can:
- Browse all available endpoints
- View request/response schemas
- Try out API calls directly from the browser
- See example requests and responses
- Download the OpenAPI specification

**Features**:
- **Interactive Testing**: Execute API calls with custom parameters
- **Authentication**: Configure authentication headers (when implemented)
- **Response Inspection**: View actual API responses
- **Schema Validation**: See validation rules for all fields

### 2. ReDoc (Documentation)

**URL**: `http://localhost:8000/redoc`

ReDoc provides a clean, readable documentation interface:
- Three-panel layout for easy navigation
- Detailed descriptions and examples
- Code samples in multiple languages
- Better for reading and understanding the API

**Features**:
- **Clean Layout**: Easy-to-read documentation format
- **Search**: Full-text search across all endpoints
- **Deep Linking**: Share links to specific endpoints
- **Print-Friendly**: Better for generating PDF documentation

### 3. OpenAPI Specification (JSON)

**URL**: `http://localhost:8000/openapi.json`

Download the raw OpenAPI 3.0 specification in JSON format:
- Use with API clients (Postman, Insomnia, etc.)
- Generate client SDKs in various languages
- Import into API management tools
- Version control and diff tracking

## Documentation Structure

### API Information

The documentation includes:
- **Title**: Prompt Lab API
- **Version**: 1.0.0
- **Description**: Comprehensive overview of features and capabilities
- **Contact**: Support email and team information
- **License**: MIT License

### Endpoint Organization

Endpoints are organized by tags:

1. **System** - Health checks and system information
2. **Agents** - Agent management operations
3. **Pipelines** - Pipeline management operations
4. **Configuration** - Configuration file management
5. **Async Execution** - Asynchronous execution and progress tracking

### Request/Response Examples

Each endpoint includes:
- **Description**: What the endpoint does
- **Parameters**: Query, path, and body parameters
- **Request Body**: Schema and examples
- **Response Codes**: All possible HTTP status codes
- **Response Body**: Schema and examples for each status code
- **Examples**: Real-world usage examples

## Using Swagger UI

### Making API Calls

1. **Navigate to Endpoint**: Click on the endpoint you want to test
2. **Click "Try it out"**: Enable the interactive form
3. **Fill Parameters**: Enter required and optional parameters
4. **Execute**: Click the "Execute" button
5. **View Response**: See the actual API response below

### Example: List Agents

```
1. Go to http://localhost:8000/docs
2. Find "GET /api/v1/agents" under "Agents" section
3. Click "Try it out"
4. Set parameters:
   - page: 1
   - page_size: 20
   - category: production
5. Click "Execute"
6. View the response with agent list
```

### Example: Execute Pipeline

```
1. Go to http://localhost:8000/docs
2. Find "POST /api/v1/executions" under "Async Execution"
3. Click "Try it out"
4. Enter request body:
   {
     "type": "pipeline",
     "target_id": "customer_service_flow",
     "inputs": {
       "customer_query": "How do I reset my password?"
     }
   }
5. Click "Execute"
6. Copy the execution_id from the response
7. Use GET /api/v1/executions/{execution_id} to check status
```

## Using ReDoc

### Navigation

- **Left Panel**: Endpoint list with search
- **Center Panel**: Detailed documentation
- **Right Panel**: Request/response examples

### Search

Use the search box to find:
- Endpoint paths
- Parameter names
- Model fields
- Description text

### Deep Linking

Share specific endpoint documentation:
```
http://localhost:8000/redoc#tag/Agents/operation/list_agents
```

## Generating Client SDKs

### Using OpenAPI Generator

1. **Download OpenAPI Spec**:
   ```bash
   curl http://localhost:8000/openapi.json > openapi.json
   ```

2. **Generate Python Client**:
   ```bash
   openapi-generator-cli generate \
     -i openapi.json \
     -g python \
     -o ./client-python
   ```

3. **Generate TypeScript Client**:
   ```bash
   openapi-generator-cli generate \
     -i openapi.json \
     -g typescript-axios \
     -o ./client-typescript
   ```

### Supported Languages

OpenAPI Generator supports 50+ languages including:
- Python
- JavaScript/TypeScript
- Java
- Go
- Ruby
- PHP
- C#
- Swift
- Kotlin

## Importing to API Tools

### Postman

1. Open Postman
2. Click "Import"
3. Select "Link" tab
4. Enter: `http://localhost:8000/openapi.json`
5. Click "Continue" and "Import"

### Insomnia

1. Open Insomnia
2. Click "Create" → "Import From"
3. Select "URL"
4. Enter: `http://localhost:8000/openapi.json`
5. Click "Fetch and Import"

### API Management Platforms

The OpenAPI specification can be imported into:
- **AWS API Gateway**: For deploying to AWS
- **Azure API Management**: For Azure deployments
- **Kong**: For API gateway management
- **Apigee**: For enterprise API management

## API Response Codes

### Success Codes

- **200 OK**: Request successful, data returned
- **201 Created**: Resource created successfully
- **202 Accepted**: Async operation started
- **204 No Content**: Success, no data to return

### Client Error Codes

- **400 Bad Request**: Invalid input parameters
- **404 Not Found**: Resource doesn't exist
- **409 Conflict**: Resource already exists

### Server Error Codes

- **500 Internal Server Error**: Unexpected error occurred

### Error Response Format

All errors follow a consistent format:
```json
{
  "error": "ErrorType",
  "message": "Human-readable error message",
  "path": "/api/v1/endpoint",
  "details": {
    "field": "parameter_name",
    "message": "Validation error details"
  }
}
```

## WebSocket Documentation

### Progress Tracking WebSocket

**Endpoint**: `ws://localhost:8000/api/v1/executions/{execution_id}/progress/ws`

**Connection Example**:
```javascript
const ws = new WebSocket(
  'ws://localhost:8000/api/v1/executions/exec_123456/progress/ws'
);

ws.onopen = () => {
  console.log('Connected to progress stream');
};

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  console.log('Progress update:', data);
  
  if (data.type === 'completed') {
    console.log('Execution completed:', data.outputs);
    ws.close();
  }
};

ws.onerror = (error) => {
  console.error('WebSocket error:', error);
};

ws.onclose = () => {
  console.log('Connection closed');
};
```

**Message Types**:
- `status`: Initial status message
- `started`: Execution started
- `progress`: Progress update
- `completed`: Execution completed successfully
- `failed`: Execution failed with error
- `cancelled`: Execution was cancelled
- `error`: WebSocket error occurred

## Best Practices

### API Versioning

The API uses URL-based versioning:
- Current version: `/api/v1/`
- Future versions: `/api/v2/`, `/api/v3/`, etc.

Always include the version in your API calls to ensure compatibility.

### Pagination

For list endpoints, use pagination parameters:
```
GET /api/v1/agents?page=1&page_size=50
```

**Best Practices**:
- Use reasonable page sizes (10-100 items)
- Cache results when possible
- Handle pagination info in responses

### Error Handling

Always check response status codes:
```python
response = requests.get('http://localhost:8000/api/v1/agents/unknown')

if response.status_code == 404:
    error = response.json()
    print(f"Agent not found: {error['message']}")
elif response.status_code == 500:
    print("Server error occurred")
else:
    agents = response.json()
```

### Async Execution

For long-running operations:
1. Start execution with POST /executions
2. Get execution_id from response
3. Poll GET /executions/{execution_id} for status
4. Or use WebSocket for real-time updates

### Rate Limiting

Currently no rate limiting is enforced, but consider:
- Implementing exponential backoff for retries
- Caching responses when appropriate
- Using WebSockets instead of polling when possible

## Customizing Documentation

### Adding Examples to Models

In `src/api/models.py`, add examples to Pydantic models:

```python
class AgentMetadataResponse(BaseModel):
    id: str
    name: str
    # ... other fields
    
    class Config:
        json_schema_extra = {
            "example": {
                "id": "mem_l1_summarizer",
                "name": "一级记忆总结",
                "category": "production",
                # ... example values
            }
        }
```

### Adding Endpoint Descriptions

In route files, use detailed docstrings:

```python
@router.get("/agents/{agent_id}")
async def get_agent(agent_id: str):
    """
    Get detailed information about a specific agent.
    
    This endpoint returns complete metadata for a single agent.
    
    **Example:**
    ```
    GET /api/v1/agents/mem_l1_summarizer
    ```
    
    **Response:**
    ```json
    {
      "id": "mem_l1_summarizer",
      "name": "一级记忆总结"
    }
    ```
    """
    pass
```

### Adding Response Examples

Use FastAPI's response model examples:

```python
@router.get(
    "/agents",
    response_model=AgentListResponse,
    responses={
        200: {
            "description": "Successful response",
            "content": {
                "application/json": {
                    "example": {
                        "agents": [...],
                        "pagination": {...}
                    }
                }
            }
        }
    }
)
async def list_agents():
    pass
```

## Troubleshooting

### Documentation Not Loading

1. **Check Server**: Ensure API server is running
   ```bash
   python -m src.api.server
   ```

2. **Check URL**: Verify you're using the correct URL
   - Swagger UI: http://localhost:8000/docs
   - ReDoc: http://localhost:8000/redoc

3. **Check Port**: Ensure port 8000 is not in use
   ```bash
   lsof -i :8000
   ```

### Missing Endpoints

1. **Check Route Registration**: Ensure routes are included in app
2. **Check Tags**: Endpoints without tags may not appear
3. **Restart Server**: Changes require server restart

### Incorrect Examples

1. **Update Model Examples**: Edit `json_schema_extra` in models
2. **Update Docstrings**: Edit endpoint docstrings
3. **Clear Cache**: Clear browser cache and reload

## Additional Resources

### FastAPI Documentation

- [FastAPI OpenAPI](https://fastapi.tiangolo.com/tutorial/metadata/)
- [Response Models](https://fastapi.tiangolo.com/tutorial/response-model/)
- [Schema Customization](https://fastapi.tiangolo.com/tutorial/schema-extra-example/)

### OpenAPI Specification

- [OpenAPI 3.0 Spec](https://swagger.io/specification/)
- [OpenAPI Generator](https://openapi-generator.tech/)
- [Swagger Tools](https://swagger.io/tools/)

### API Design

- [REST API Best Practices](https://restfulapi.net/)
- [API Design Patterns](https://microservices.io/patterns/apigateway.html)
- [HTTP Status Codes](https://httpstatuses.com/)

## Support

For questions or issues with the API documentation:
- Check the [API Design Specification](./api-design-specification.md)
- Review the [API Setup Guide](./api-setup-guide.md)
- Contact the development team

## Version History

- **1.0.0** (2024-12-17): Initial OpenAPI documentation
  - Swagger UI configured
  - ReDoc configured
  - Comprehensive endpoint documentation
  - Request/response examples
  - WebSocket documentation
